<!DOCTYPE html>
<html>
<head>
    <title>性能可视化</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            height: 100vh;
            background: #f0f2f5;
        }
        .container {
            width: 100%;
            height: 90vh;
            padding: 20px;
            box-sizing: border-box;
        }
        .chart-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 0;
            padding: 20px;
            flex-grow: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .drop-hint {
            color: #9ca3af;
            font-size: 24px;
            pointer-events: none;
            position: absolute;
            text-align: center;
            transition: opacity 0.3s ease;
        }
        .chart-card {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .chart-card.dragover {
            border: 2px dashed #8aedc2;
            background-color: #f5fffb;
        }
        #charts-container {
            display: flex;
            flex-direction: column;
            gap: 24px;
            height: 100%;
            padding: 10px;
        }
        /* 悬停样式优化 */
        .hoverlayer line {
            stroke: #7CD0FF !important;
            stroke-width: 1px !important;
            filter: drop-shadow(0 0 3px rgba(124, 208, 255, 0.8)) !important;
            fill: none !important;
        }
        .hoverlayer rect.bg {
            stroke: none !important;
            rx: 8px !important;
            filter: drop-shadow(0 2px 8px rgba(0,0,0,0.1)) !important;
            fill: white !important;
        }

        /* 更新下拉菜单项样式 */
        .updatemenu-item-rect {
            rx: 8 !important;
            ry: 8 !important;
            stroke: #e5e7eb !important;
            stroke-width: 1px !important;
            fill: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%) !important;
            filter: drop-shadow(0 2px 6px rgba(0,0,0,0.05)) !important;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }

        .updatemenu-item-text {
            fill: #374151 !important;
            font-family: 'Segoe UI' !important;
            font-size: 13px !important;
            font-weight: 500 !important;
        }

        .updatemenu-item-rect:hover {
            fill: #f3f4f6 !important;
            stroke: #d1d5db !important;
            filter: drop-shadow(0 2px 8px rgba(0,0,0,0.1)) !important;
        }

        /* 增强图例标题样式 */
        .legendtitletext {
            padding-top: 5px;
            font-weight: 700 !important;
            font-size: 15px !important;
            font-family: 'Segoe UI' !important;
        }
        .legendtext {
            font-size: 13px !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <input type="file" id="hiddenFile" accept=".db,.sqlite" style="display: none">
        <div id="charts-container">
            <div class="chart-card" id="chart1">
                <div class="drop-hint">点击选择或拖入SQLite数据库</div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <script>
        let inSync = false;
        initSqlJs({
            locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
        }).then(SQL => window.SQL = SQL);

        let chartCreated = false;
        const chartCard = document.getElementById('chart1');
        const hiddenInput = document.getElementById('hiddenFile');

        // 统一文件处理函数
        async function handleFile(file) {
            if (!file.name.match(/\.(db|sqlite)$/)) {
                alert('仅支持.db和.sqlite文件');
                return;
            }

            try {
                const SQLInstance = await SQL;
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const Uints = new Uint8Array(e.target.result);
                    const database = new SQLInstance.Database(Uints);

                    const perfData = database.exec(`
                        SELECT timestamp, threads_num, cpu_percent, memory_mb,
                               read_bytes, write_bytes, read_mbps, write_mbps
                        FROM process_stats
                    `);

                    if (!perfData?.[0]?.values) throw new Error('数据库查询结果格式无效');

                    const data = perfData[0].values.map((row, index) => ({
                        timestamp: new Date(row[0]),
                        threadCount: row[1],
                        cpuUsage: row[2],
                        memoryUsage: row[3],
                        readBytes: (row[4]/1048576).toFixed(2),
                        writeBytes: (row[5]/1048576).toFixed(2),
                        readMbps: row[6],
                        writeMbps: row[7],
                    }));

                    if (chartCreated) {
                        Plotly.react('chart1', traces, layout);
                    } else {
                        createCharts(data);
                        document.querySelector('.drop-hint').style.opacity = '0';
                        chartCreated = true;
                    }
                };
                reader.readAsArrayBuffer(file);
            } catch (error) {
                alert('文件处理失败: ' + error.message);
            }
        }

        // 点击卡片选择文件
        chartCard.addEventListener('click', () => {
            if (!chartCreated) hiddenInput.click();
        });

        // 拖拽事件处理
        chartCard.addEventListener('dragover', (e) => {
            e.preventDefault();
            chartCard.classList.add('dragover');
        });

        chartCard.addEventListener('dragleave', () => {
            chartCard.classList.remove('dragover');
        });

        chartCard.addEventListener('drop', (e) => {
            e.preventDefault();
            chartCard.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) {
                handleFile(file);
                document.querySelector('.drop-hint').style.opacity = '0';
            }
        });

        // 隐藏input的文件选择事件
        hiddenInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleFile(file);
        });

        function createCharts(data) {
            const layout = {
                hovermode: 'x unified',
                plot_bgcolor: '#f8f9fa',
                paper_bgcolor: '#ffffff',
                margin: {t: 80, r: 30, l: 50, b: 40}, // 增加顶部间距容纳标题
                font: {family: 'Segoe UI', size: 12},
                title: {
                    text: '性能指标趋势图',
                    x: 0.05,
                    y: 0.95,
                    font: {size: 18}
                },
                xaxis: {showgrid: true, gridcolor: '#e5e7eb'},
                yaxis: {
                    showgrid: true,
                    gridcolor: '#e5e7eb',
                    title: {
                        standoff: 20 // Y轴标题与轴的距离
                    },
                    ticklabelpadding: 10 // 刻度标签与轴线的距离
                }
            };

            // 计算各参数范围
            const calcRange = (values, bufferPercent = 5) => {
                const max = Math.max(...values);
                const min = Math.min(...values);
                return [Math.max(0, min - (max - min)*bufferPercent/100), max + (max - min)*bufferPercent/100];
            };

            // 获取各参数范围
           const ranges = {
               threadCount: calcRange(data.map(d => d.threadCount), 30),
               cpuUsage: calcRange(data.map(d => d.cpuUsage)),
               memoryUsage: calcRange(data.map(d => d.memoryUsage)),
               readMbps: calcRange(data.map(d => d.readMbps)),
               writeMbps: calcRange(data.map(d => d.writeMbps)),
               readBytes: calcRange(data.map(d => d.readBytes)),
               writeBytes: calcRange(data.map(d => d.writeBytes))
           };
           if (ranges.readMbps[1] == 0) ranges.readMbps[1] = 100;
           if (ranges.writeMbps[1] == 0) ranges.writeMbps[1] = 100;
           if (ranges.readBytes[1] == 0) ranges.readBytes[1] = 100;
           if (ranges.writeBytes[1] == 0) ranges.writeBytes[1] = 100;

           const normByRange = (value, dataRange) => {
              return (value - dataRange[0]) / (dataRange[1] - dataRange[0]);
           };

            const traces = [
               {
                   x: data.map(d => d.timestamp),
                   y: data.map(d => normByRange(d.threadCount, ranges.threadCount)),
                   customdata: data.map(d => d.threadCount),
                   name: '线程数',
                   type: 'scatter',
                   line: {color: '#6366f1'},
                   yaxis: 'y',
                   visible: true,
                   hovertemplate: '线程数:  <b>%{customdata}</b><extra></extra>'
               },
               {
                   x: data.map(d => d.timestamp),
                   y: data.map(d => normByRange(d.cpuUsage, ranges.cpuUsage)),
                   customdata: data.map(d => d.cpuUsage),
                   name: 'CPU使用率 (%)',
                   type: 'scatter',
                   line: {color: '#10b981'},
                   yaxis: 'y',
                   visible: true,
                   hovertemplate: 'CPU使用率(%):  <b>%{customdata}</b><extra></extra>'
               },
               {
                   x: data.map(d => d.timestamp),
                   y: data.map(d => normByRange(d.memoryUsage, ranges.memoryUsage)),
                   customdata: data.map(d => d.memoryUsage),
                   name: '内存使用量 (MB)',
                   type: 'scatter',
                   line: {color: '#f59e0b'},
                   yaxis: 'y',
                   visible: true,
                   hovertemplate: '内存使用量 (MB):  <b>%{customdata}</b><extra></extra>'
               },
               {
                   x: data.map(d => d.timestamp),
                   y: data.map(d => normByRange(d.readMbps, ranges.readMbps)),
                   customdata: data.map(d => d.readMbps),
                   name: '读取速度 (MB/s)',
                   type: 'scatter',
                   line: {color: '#3b82f6'},
                   yaxis: 'y',
                   visible: true,
                   hovertemplate: '读取速度 (MB/s):  <b>%{customdata}</b><extra></extra>'
               },
               {
                   x: data.map(d => d.timestamp),
                   y: data.map(d => normByRange(d.writeMbps, ranges.writeMbps)),
                   customdata: data.map(d => d.writeMbps),
                   name: '写入速度 (MB/s)',
                   type: 'scatter',
                   line: {color: '#ef4444'},
                   yaxis: 'y',
                   visible: true,
                   hovertemplate: '写入速度 (MB/s):  <b>%{customdata}</b><extra></extra>'
               },
               {
                   x: data.map(d => d.timestamp),
                   y: data.map(d => normByRange(d.readBytes, ranges.readBytes)),
                   customdata: data.map(d => d.readBytes),
                   name: '读取总量 (MB)',
                   type: 'scatter',
                   line: {color: '#8b5cf6'},
                   yaxis: 'y',
                   visible: true,
                   hovertemplate: '读取总量 (MB):  <b>%{customdata}</b><extra></extra>'
               },
               {
                   x: data.map(d => d.timestamp),
                   y: data.map(d => normByRange(d.writeBytes, ranges.writeBytes)),
                   customdata: data.map(d => d.writeBytes),
                   name: '写入总量 (MB)',
                   type: 'scatter',
                   line: {color: '#ec4899'},
                   yaxis: 'y',
                   visible: true,
                   hovertemplate: '写入总量 (MB):  <b>%{customdata}</b><extra></extra>'
               }
           ];

           const yaxisText = (range, fixed = 2) => {
                return [
                    (range[0]).toFixed(fixed),
                    ((range[0] + range[1])*0.25).toFixed(fixed),
                    ((range[0] + range[1])/2).toFixed(fixed),
                    ((range[0] + range[1])*0.75).toFixed(fixed),
                    (range[1]).toFixed(fixed)]
           };

           const chart = Plotly.newPlot('chart1', traces, {
               ...layout,
               yaxis: {
                   title: 'CPU使用率 (%)',
                   range: [0, 1],
                   tickvals: [0, 0.25, 0.5, 0.75, 1],
                   ticktext: yaxisText(ranges.cpuUsage),
                   showgrid: true,
                   gridcolor: '#e5e7eb'
               },
               updatemenus: [{
                   type: 'dropdown',
                   buttons: [
                       {
                           method: 'relayout',
                           args: [{'yaxis.title': '线程数', 'yaxis.ticktext': yaxisText(ranges.threadCount, 0)}],
                           label: '线程数'
                       },
                       {
                           method: 'relayout',
                           args: [{'yaxis.title': 'CPU使用率 (%)', 'yaxis.ticktext': yaxisText(ranges.cpuUsage, 2)}],
                           label: 'CPU使用率'
                       },
                       {
                           method: 'relayout',
                           args: [{'yaxis.title': '内存使用量 (MB)', 'yaxis.ticktext': yaxisText(ranges.memoryUsage, 1)}],
                           label: '内存使用量'
                       },
                       {
                           method: 'relayout',
                           args: [{'yaxis.title': '读取速度 (MB/s)', 'yaxis.ticktext': yaxisText(ranges.readMbps)}],
                           label: '读取速度'
                       },
                       {
                           method: 'relayout',
                           args: [{'yaxis.title': '写入速度 (MB/s)', 'yaxis.ticktext': yaxisText(ranges.writeMbps)}],
                           label: '写入速度'
                       },
                       {
                           method: 'relayout',
                           args: [{'yaxis.title': '读取总量 (MB)', 'yaxis.ticktext': yaxisText(ranges.readBytes, 1)}],
                           label: '读取总量'
                       },
                       {
                           method: 'relayout',
                           args: [{'yaxis.title': '写入总量 (MB)', 'yaxis.ticktext': yaxisText(ranges.writeBytes, 1)}],
                           label: '写入总量'
                       }
                   ],
                   active: 1,
                   showactive: true,
                   x: 1.020,  // 将下拉菜单移到右侧
                   xanchor: 'left',  // 右对齐
                   y: 0.75,  // 调整垂直位置到图例下方
                   yanchor: 'top'
               }]
            });
        }
    </script>
</body>
</html>
