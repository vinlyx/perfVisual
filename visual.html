<!DOCTYPE html>
<html>
<head>
    <!-- 性能可视化仪表盘主页面 -->
    <title>Performance Visualizer</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 20px;
            background: #f0f2f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .chart-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 24px;
            padding: 20px;
        }
        input[type="file"] {
            margin: 20px 0;
            padding: 12px;
            background: #fff;
            border: 2px dashed #6366f1;
            border-radius: 8px;
            width: 300px;
        }
        #charts-container {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
    </style>
</head>
<body>
    <div class="container">
        <input type="file" id="dbFile" accept=".db,.sqlite">
        <div id="charts-container">
            <div class="chart-card" id="chart1"></div>
            <div class="chart-card" id="chart2"></div>
            <div class="chart-card" id="chart3"></div>
        </div>
    </div>

    <script>
        // 主数据库实例
        let db;

        // 初始化SQL.js
        window.initSqlJs({
            locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
        }).then(SQL => {
            document.getElementById('dbFile').addEventListener('change', function(e) {
                const file = e.target.files[0];
                const reader = new FileReader();

                reader.onload = function() {
                    try {
                        const Uints = new Uint8Array(reader.result);
                        db = new SQL.Database(Uints);
                        processData();
                    } catch (error) {
                        console.error('数据库加载失败:', error);
                    }
                };
                reader.readAsArrayBuffer(file);
            });
        });

        /**
         * 处理数据库数据并生成可视化图表
         * 1. 执行SQL查询获取性能数据
         * 2. 转换数据格式供图表使用
         * 3. 调用图表生成函数
         */
        function processData() {
            try {
                // 执行SQL查询获取原始性能数据
                const perfData = db.exec(`SELECT
                    timestamp,
                    threads_num,
                    cpu_percent,
                    memory_mb,
                    read_bytes,
                    write_bytes,
                    read_mbps,
                    write_mbps
                FROM process_stats`);
                const rows = perfData[0]?.values;

                if (!rows) {
                    alert('数据库格式不符合要求');
                    return;
                }

                // 处理数据
                const data = rows.map(row => ({
                    timestamp: new Date(row[0]),
                    threadCount: row[1],
                    cpuUsage: row[2],
                    memoryUsage: row[3],
                    readBytes: row[4],
                    writeBytes: row[5],
                    readMbps: row[6],
                    writeMbps: row[7]
                }));

                // 生成图表数据
                createCharts(data);
            } catch (error) {
                console.error('数据查询失败:', error);
            }
        }

        /**
         * 创建可视化图表
         * @param {Array} data - 处理后的性能数据数组
         * 包含以下字段:
         * - timestamp: 时间戳
         * - threadCount: 线程数
         * - cpuUsage: CPU使用率
         * - memoryUsage: 内存使用量
         * - readBytes: 读取字节数
         * - writeBytes: 写入字节数
         * - readMbps: 读取速度
         * - writeMbps: 写入速度
         */
        function createCharts(data) {
            // 通用配置
            const layout = {
                hovermode: 'closest',
                plot_bgcolor: '#f8f9fa',
                paper_bgcolor: '#ffffff',
                margin: {t: 30, r: 30, l: 50, b: 40},
                font: {family: 'Segoe UI', size: 12},
                xaxis: {
                    showgrid: true,
                    gridcolor: '#e5e7eb'
                },
                yaxis: {
                    showgrid: true,
                    gridcolor: '#e5e7eb'
                }
            };

            // 图表1：线程/CPU/内存
            const trace1 = {
                x: data.map(d => d.timestamp),
                y: data.map(d => d.threadCount),
                name: '线程数',
                type: 'scatter',
                line: {color: '#6366f1'}
            };

            const trace2 = {
                x: data.map(d => d.timestamp),
                y: data.map(d => d.cpuUsage),
                name: 'CPU使用率 (%)',
                type: 'scatter',
                line: {color: '#10b981'}
            };

            const trace3 = {
                x: data.map(d => d.timestamp),
                y: data.map(d => d.memoryUsage),
                name: '内存使用量 (MB)',
                type: 'scatter',
                line: {color: '#f59e0b'}
            };

            Plotly.newPlot('chart1', [trace1, trace2, trace3], {
                ...layout,
                title: '系统资源使用情况',
                yaxis: {title: '数值'}
            });

            // 图表2：读取数据
            const readMB = data.map(d => d.readBytes / (1024 * 1024)).map(v => v.toFixed(2));
            const readSpeed = data.map(d => d.readMbps);

            const trace4 = {
                x: data.map(d => d.timestamp),
                y: readMB,
                name: '读取数据量 (MB)',
                type: 'scatter',
                line: {color: '#3b82f6'}
            };

            const trace5 = {
                x: data.map(d => d.timestamp),
                y: readSpeed,
                name: '读取速度 (MB/s)',
                type: 'scatter',
                line: {color: '#8b5cf6'}
            };

            Plotly.newPlot('chart2', [trace4, trace5], {
                ...layout,
                title: '数据读取性能',
                yaxis: {title: '数值'}
            });

            // 图表3：写入数据
            const writeMB = data.map(d => d.writeBytes / (1024 * 1024)).map(v => v.toFixed(2));
            const writeSpeed = data.map(d => d.writeMbps);

            const trace6 = {
                x: data.map(d => d.timestamp),
                y: writeMB,
                name: '写入数据量 (MB)',
                type: 'scatter',
                line: {color: '#ef4444'}
            };

            const trace7 = {
                x: data.map(d => d.timestamp),
                y: writeSpeed,
                name: '写入速度 (MB/s)',
                type: 'scatter',
                line: {color: '#f97316'}
            };

            Plotly.newPlot('chart3', [trace6, trace7], {
                ...layout,
                title: '数据写入性能',
                yaxis: {title: '数值'}
            });

            // 图表联动
            const charts = ['chart1', 'chart2', 'chart3'];
            charts.forEach(chartId => {
                document.getElementById(chartId).on('plotly_relayout', event => {
                    if (event['xaxis.range[0]']) {
                        charts.forEach(otherChartId => {
                            if (otherChartId !== chartId) {
                                Plotly.relayout(otherChartId, {
                                    'xaxis.range': [event['xaxis.range[0]'], event['xaxis.range[1]']]
                                });
                            }
                        });
                    }
                });
            });
        }
    </script>
</body>
</html>
